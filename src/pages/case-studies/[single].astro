---
import Base from "@/layouts/Base.astro";
import CaseStudySingle from "@/layouts/CaseStudySingle.astro";
import Breadcrumbs from "@/layouts/components/Breadcrumbs.astro";
import { sanityClient } from "sanity:client";

const { single } = Astro.params;

const caseStudy = await sanityClient.fetch(`
  *[_type == "caseStudy" && slug.current == $slug][0] {
    "slug": slug.current,
    title,
    metaTitle,
    metaDescription,
    canonicalUrl,
    "seoImage": image.asset->url,
    category,
    description,
    excerpt,
    challenge,
    "solution": solution[] {
      ...,
      _type == "image" => {
        ...,
        "asset": {
          ...,
          "url": asset->url
        }
      }
    },
    "results": results[] {
      ...,
      _type == "image" => {
        ...,
        "asset": {
          ...,
          "url": asset->url
        }
      }
    },
    metrics,
    industry,
    duration,
    services,
    publishedAt,
    "logo": logo {
      asset->{
        url
      },
      alt
    },

    "featuredImage": featuredImage {
      asset->{
        url
      },
      alt
    },
    
    ctaSection {
      isVisible,
      tagline,
      title,
      subtitle,
      description,
      metrices[] {
        value,
        label,
        icon
      },
      buttons[] {
        label,
        link,
        isOpenBooking
      },
      image {
        "src": src.asset->url,
        alt
      }
    }
  }
`, { slug: single });

// Handle 404 if case study not found
if (!caseStudy) {
  return Astro.redirect("/404");
}

const { title, metaTitle, metaDescription, canonicalUrl, seoImage, excerpt, featuredImage } = caseStudy;
---

<Base
  title={title}
  meta_title={metaTitle || `${title} - Case Study - Exprosoftech`}
  description={metaDescription || excerpt || ""}
  canonical={canonicalUrl}
  image={seoImage || featuredImage?.asset?.url}>
  
  <!-- Breadcrumbs -->
  <section class="section-sm">
    <div class="container">
      <div class="row">
        <div class="col-12">
          <Breadcrumbs className="mt-4" />
        </div>
      </div>
    </div>
  </section>

  <CaseStudySingle caseStudy={caseStudy} />
</Base> 