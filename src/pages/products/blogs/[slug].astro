---
import Base from "@/layouts/Base.astro";
import BlogSingle from "@/layouts/BlogSingle.astro";
import { sanityClient } from "sanity:client";
import { DynamicCTA } from "../../../components/DynamicCTA";

const { slug } = Astro.params;

const post = await sanityClient.fetch(`
  *[_type == "productBlog" && slug.current == $slug][0] {
    "slug": slug.current,
    seoTitle,
    seoDescription,
    canonicalUrl,
    isLive,
    title,
    date,
    "image": image.asset->url,
    "imageAlt": image.alt,
    "body": body[] {
      ...,
      _type == "image" => {
        ...,
        "asset": {
          ...,
          "url": asset->url
        }
      }
    },
    excerpt,
    "author": author->{
      name,
      "slug": slug.current,
      "image": image.asset->url
    },
    ctaSection {
      tagline,
      title,
      subtitle,
      description,
      metrices[] {
        value,
        label,
        icon
      },
      buttons[] {
        label,
        link,
        isOpenBooking
      },
      image {
        "src": src.asset->url,
        alt
      }
    }
  }
`, { slug });

// Handle 404 if post not found
if (!post) {
  return Astro.redirect("/404");
}

// Check hostname and isLive status
const hostname = Astro.url.hostname;
if (hostname === 'exprosoftech.com' && !post.isLive) {
  return Astro.redirect('/404');
}
const { title, excerpt, image, imageAlt, seoTitle, seoDescription, canonicalUrl } = post;
---

<Base
  title={seoTitle || title}
  meta_title={seoTitle || title}
  description={seoDescription || excerpt || ""}
  image={image}
  canonical={canonicalUrl}>
  <BlogSingle post={{...post, imageAlt}} />
  
  {post.ctaSection && (
    <DynamicCTA client:visible ctaContent={post.ctaSection} />
  )}
</Base> 